<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="../css/global.css" />
</head>
<body>
  <div class="container">
    <h1>Teacher Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Register Student</h2>
      <form id="registerStudentForm" class="teacher-form">
        <label for="studentUsername">Student Username:</label>
        <input type="text" id="studentUsername" name="studentUsername" required />
        <label for="studentPassword">Password:</label>
        <input type="password" id="studentPassword" name="studentPassword" required />
        <label for="studentGrade">Grade Level:</label>
        <select id="studentGrade" name="studentGrade" required>
          <option value="" disabled selected>Select grade</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
        </select>
        <button type="submit">Register Student</button>
      </form>
      <div id="registerMessage"></div>
    </section>

    <section>
      <h2>Your Uploaded Modules</h2>
      <div id="modulesList"></div>
    </section>
  </div>

  <script>
    // Check if user is teacher
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'teacher') {
      alert('Access denied. Please login as Teacher.');
      window.location.href = '../index.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = '../index.html';
    });

    // Load students and registration requests
    function loadStudents() {
      return JSON.parse(localStorage.getItem('students')) || [];
    }

    function loadRegistrationRequests() {
      return JSON.parse(localStorage.getItem('registrationRequests')) || [];
    }

    function saveRegistrationRequests(requests) {
      localStorage.setItem('registrationRequests', JSON.stringify(requests));
    }

    // Register student (adds to registration requests)
    const registerStudentForm = document.getElementById('registerStudentForm');
    const registerMessage = document.getElementById('registerMessage');
    registerStudentForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('studentUsername').value.trim();
      const password = document.getElementById('studentPassword').value.trim();
      const grade = document.getElementById('studentGrade').value;

      if (!username || !password || !grade) {
        registerMessage.textContent = 'Please fill all fields.';
        return;
      }

      // Check if username already exists in students or registration requests
      const students = loadStudents();
      const requests = loadRegistrationRequests();
      if (students.find(s => s.username === username) || requests.find(r => r.username === username)) {
        registerMessage.textContent = 'Username already exists.';
        return;
      }

      requests.push({ username, password, grade });
      saveRegistrationRequests(requests);
      registerMessage.style.color = 'green';
      registerMessage.textContent = 'Student registration request submitted.';
      registerStudentForm.reset();
      renderRegistrationRequests();
    });

    // Render registration requests for teacher info
    function renderRegistrationRequests() {
      const requests = loadRegistrationRequests();
      const container = document.getElementById('registerMessage');
      if (requests.length > 0) {
        container.textContent = 'There are pending student registration requests for Admin approval.';
      } else {
        container.textContent = '';
      }
    }

    // Initial render
    renderRegistrationRequests();

    // Load modules and quizzes from localStorage
    function loadModules() {
      return JSON.parse(localStorage.getItem('modules')) || [];
    }

    function loadQuizzes() {
      return JSON.parse(localStorage.getItem('quizzes')) || [];
    }

    function saveModules(modules) {
      localStorage.setItem('modules', JSON.stringify(modules));
    }

    function saveQuizzes(quizzes) {
      localStorage.setItem('quizzes', JSON.stringify(quizzes));
    }

    // Render modules uploaded by the teacher
    function renderModules() {
      const modules = loadModules();
      const container = document.getElementById('modulesList');
      container.innerHTML = '';

      if (modules.length === 0) {
        container.textContent = 'No modules uploaded yet.';
        return;
      }

      modules.forEach(module => {
        const div = document.createElement('div');
        div.className = 'module-item';
        div.style.border = '1px solid #ccc';
        div.style.padding = '1rem';
        div.style.marginBottom = '1rem';
        div.innerHTML = `
          <h3>${module.title}</h3>
          <p><strong>Description:</strong> ${module.description}</p>
          <p><strong>Grade:</strong> ${module.grade}</p>
          <button data-id="${module.id}" class="deleteModuleBtn">Delete Module</button>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll('.deleteModuleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const moduleId = parseInt(e.target.getAttribute('data-id'));
          if (confirm('Are you sure you want to delete this module?')) {
            deleteModule(moduleId);
          }
        });
      });
    }

    // Delete module and related quizzes
    function deleteModule(moduleId) {
      let modules = loadModules();
      let quizzes = loadQuizzes();

      modules = modules.filter(m => m.id !== moduleId);
      quizzes = quizzes.filter(q => q.moduleId !== moduleId);

      saveModules(modules);
      saveQuizzes(quizzes);

      alert('Module and related quizzes deleted successfully.');
      renderModules();
    }

    renderModules();
  </script>
</body>
</html>
