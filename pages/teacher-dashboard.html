<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="../css/global.css" />
</head>
<body>
  <div class="container">
    <h1>Teacher Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Register Student</h2>
<form id="registerStudentForm" class="teacher-form">
        <label for="studentUsername">Student Username:</label>
        <input type="text" id="studentUsername" name="studentUsername" required />
        <label for="studentPassword">Password:</label>
        <input type="password" id="studentPassword" name="studentPassword" required />
        <label for="studentGrade">Grade Level:</label>
        <select id="studentGrade" name="studentGrade" required>
          <option value="" disabled selected>Select grade</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
        </select>
        <button type="submit">Register Student</button>
      </form>
      <div id="registerMessage"></div>
    </section>

    <section>
      <h2>Add Learning Module</h2>
      <form id="addModuleForm" enctype="multipart/form-data">
        <label for="moduleTitle">Module Title:</label>
        <input type="text" id="moduleTitle" name="moduleTitle" required />
        <label for="moduleDescription">Module Description:</label>
        <textarea id="moduleDescription" name="moduleDescription" rows="3" required></textarea>
        <label for="moduleGrade">Grade Level:</label>
        <select id="moduleGrade" name="moduleGrade" required>
          <option value="" disabled selected>Select grade</option>
          <option value="4">Grade 4</option>
          <option value="5">Grade 5</option>
          <option value="6">Grade 6</option>
        </select>
        <label for="moduleFile">Upload Module File:</label>
        <input type="file" id="moduleFile" name="moduleFile" accept=".pdf,.doc,.docx,.txt" required />
        <button type="submit">Add Module</button>
      </form>
      <div id="moduleMessage"></div>
    </section>

    <section>
      <h2>Modules</h2>
      <div id="modulesList"></div>
    </section>

    <section>
      <h2>Student Progress</h2>
      <div id="studentProgress"></div>
    </section>
  </div>

  <script>
    // Check if user is teacher
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'teacher') {
      alert('Access denied. Please login as Teacher.');
      window.location.href = '../index.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = '../index.html';
    });

    // Load students and registration requests
    function loadStudents() {
      return JSON.parse(localStorage.getItem('students')) || [];
    }

    function loadRegistrationRequests() {
      return JSON.parse(localStorage.getItem('registrationRequests')) || [];
    }

    function saveRegistrationRequests(requests) {
      localStorage.setItem('registrationRequests', JSON.stringify(requests));
    }

    // Register student (adds to registration requests)
    const registerStudentForm = document.getElementById('registerStudentForm');
    const registerMessage = document.getElementById('registerMessage');
    registerStudentForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('studentUsername').value.trim();
      const password = document.getElementById('studentPassword').value.trim();
      const grade = document.getElementById('studentGrade').value;

      if (!username || !password || !grade) {
        registerMessage.textContent = 'Please fill all fields.';
        return;
      }

      // Check if username already exists in students or registration requests
      const students = loadStudents();
      const requests = loadRegistrationRequests();
      if (students.find(s => s.username === username) || requests.find(r => r.username === username)) {
        registerMessage.textContent = 'Username already exists.';
        return;
      }

      requests.push({ username, password, grade });
      saveRegistrationRequests(requests);
      registerMessage.style.color = 'green';
      registerMessage.textContent = 'Student registration request submitted.';
      registerStudentForm.reset();
      renderRegistrationRequests();
    });

    // Add learning module
    const addModuleForm = document.getElementById('addModuleForm');
    const moduleMessage = document.getElementById('moduleMessage');
    addModuleForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('moduleTitle').value.trim();
      const description = document.getElementById('moduleDescription').value.trim();
      const grade = document.getElementById('moduleGrade').value;
      const fileInput = document.getElementById('moduleFile');
      const file = fileInput.files[0];

      if (!title || !description || !grade || !file) {
        moduleMessage.textContent = 'Please fill all fields and select a file.';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        const fileData = event.target.result; // base64 string

        const modules = JSON.parse(localStorage.getItem('modules')) || [];
        const newModule = {
          id: Date.now(),
          title,
          description,
          grade,
          fileName: file.name,
          fileType: file.type,
          fileData,
          questions: []
        };
        modules.push(newModule);
        localStorage.setItem('modules', JSON.stringify(modules));
        moduleMessage.style.color = 'green';
        moduleMessage.textContent = 'Module added successfully.';
        addModuleForm.reset();
        renderModules();
      };
      reader.readAsDataURL(file);
    });

    // Render modules list
    function renderModules() {
      const container = document.getElementById('modulesList');
      const modules = JSON.parse(localStorage.getItem('modules')) || [];
      container.innerHTML = '';
      if (modules.length === 0) {
        container.textContent = 'No modules added yet.';
        return;
      }
      modules.forEach(module => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '0.5rem';
        div.style.marginBottom = '0.5rem';
        div.innerHTML = `
          <h3>${module.title} (Grade ${module.grade})</h3>
          <p>${module.description}</p>
          <a href="${module.fileData}" download="${module.fileName}">Download Module</a>
          <button data-id="${module.id}" class="manageQuestionsBtn">Manage Questions</button>
        `;
        container.appendChild(div);
      });

      // Add event listeners for manage questions buttons
      document.querySelectorAll('.manageQuestionsBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const moduleId = e.target.getAttribute('data-id');
          window.location.href = 'modules.html?moduleId=' + moduleId;
        });
      });
    }

    // Render student progress
    function renderStudentProgress() {
      const container = document.getElementById('studentProgress');
      const students = loadStudents();
      const progress = JSON.parse(localStorage.getItem('progress')) || {};
      container.innerHTML = '';
      if (students.length === 0) {
        container.textContent = 'No registered students.';
        return;
      }
      students.forEach(student => {
        const studentProgress = progress[student.username] || {};
        const progressSummary = Object.keys(studentProgress).length > 0
          ? Object.entries(studentProgress).map(([moduleId, data]) => {
              return `<li>Module ID ${moduleId}: ${data.completed ? 'Completed' : 'In Progress'}</li>`;
            }).join('')
          : 'No progress yet.';
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '0.5rem';
        div.style.marginBottom = '0.5rem';
        div.innerHTML = `
          <p><strong>${student.username} (Grade ${student.grade})</strong></p>
          <ul>${progressSummary}</ul>
        `;
        container.appendChild(div);
      });
    }

    // Render registration requests for teacher info
    function renderRegistrationRequests() {
      const requests = loadRegistrationRequests();
      const container = document.getElementById('registerMessage');
      if (requests.length > 0) {
        container.textContent = 'There are pending student registration requests for Admin approval.';
      } else {
        container.textContent = '';
      }
    }

    // Initial render
    renderModules();
    renderStudentProgress();
    renderRegistrationRequests();
  </script>
</body>
</html>
