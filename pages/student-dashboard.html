<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="../css/global.css" />
</head>
<body>
  <div class="container">
    <h1>Student Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Available Modules</h2>
      <div id="modulesList"></div>
      <div id="progressSummary" style="margin-top: 1rem;"></div>
    </section>

    <div id="questionContainer"></div>

  <section>
    <h2>Final Assessments</h2>
    <div id="finalAssessmentsContainer"></div>
  </section>
  </div>

  <script>
    // Check if user is student
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'student') {
      alert('Access denied. Please login as Student.');
      window.location.href = '../index.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = '../index.html';
    });

    const modulesList = document.getElementById('modulesList');

    let modules = JSON.parse(localStorage.getItem('modules')) || [];
    let progress = JSON.parse(localStorage.getItem('progress')) || {};

    // Filter modules by student's grade level
    const students = JSON.parse(localStorage.getItem('students')) || [];
    const studentInfo = students.find(s => s.username === currentUser.username);
    const studentGrade = studentInfo ? studentInfo.grade : null;

    function filterModulesByGrade() {
      // Filter modules to only those matching the student's grade
      if (!studentGrade) {
        return [];
      }
      return modules.filter(m => m.grade === studentGrade);
    }

    function renderModulesList() {
      const filteredModules = filterModulesByGrade();
      modulesList.innerHTML = '';
      if (filteredModules.length === 0) {
        modulesList.textContent = 'No modules available.';
        return;
      }
      filteredModules.forEach(module => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '0.5rem';
        div.style.marginBottom = '0.5rem';

        // Calculate progress for this module for current user
        const userModuleProgress = progress[currentUser.username]?.[module.id];
        let progressPercent = 0;
        if (userModuleProgress) {
          const totalQuestions = module.questions ? module.questions.length : 0;
          if (totalQuestions > 0) {
            if (userModuleProgress.completed) {
              progressPercent = 100;
            } else {
              progressPercent = Math.floor((userModuleProgress.currentQuestionIndex / totalQuestions) * 100);
            }
          }
        }

        div.innerHTML = `
          <h3>${module.title}</h3>
          <p>${module.description}</p>
          <p>Progress: ${progressPercent}%</p>
          <button data-id="${module.id}" class="viewModuleBtn">View Module</button>
        `;
        modulesList.appendChild(div);
      });

      document.querySelectorAll('.viewModuleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const moduleId = e.target.getAttribute('data-id');
          const module = modules.find(m => m.id == moduleId);
          if (!module) return;

          // Create a temporary link to download the file
          const link = document.createElement('a');
          link.href = module.pdfData || module.fileData || '';
          link.download = module.title ? module.title.replace(/\s+/g, '_') + '.pdf' : 'module.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      });
    }

    // New function to view module PDF and quiz side by side
    function viewModule(moduleId) {
      const module = modules.find(m => m.id == moduleId);
      if (!module) return;

      // Clear previous content
      const currentModuleTitle = document.getElementById('currentModuleTitle');
      if (currentModuleTitle) currentModuleTitle.textContent = module.title;

      const currentModuleDescription = document.getElementById('currentModuleDescription');
      if (currentModuleDescription) currentModuleDescription.textContent = '';

      const questionContainer = document.getElementById('questionContainer');
      if (questionContainer) {
        questionContainer.innerHTML = '';
        // Removed quiz questions rendering as per user request
      }

      // Display uploaded module file if available
      if (module.pdfData) {
        let pdfViewer = document.getElementById('pdfViewer');
        if (!pdfViewer) {
          pdfViewer = document.createElement('embed');
          pdfViewer.id = 'pdfViewer';
          pdfViewer.type = 'application/pdf';
          pdfViewer.style.width = '100%';
          pdfViewer.style.height = '600px';
          questionContainer.parentNode.insertBefore(pdfViewer, questionContainer.nextSibling);
        }
        pdfViewer.src = module.pdfData;

        // Add download link for the uploaded file
        let downloadLink = document.getElementById('downloadModuleFile');
        if (!downloadLink) {
          downloadLink = document.createElement('a');
          downloadLink.id = 'downloadModuleFile';
          downloadLink.textContent = 'Download Module File';
          downloadLink.style.display = 'block';
          downloadLink.style.marginTop = '1rem';
          downloadLink.style.fontWeight = 'bold';
          questionContainer.parentNode.insertBefore(downloadLink, pdfViewer.nextSibling);
        }
        downloadLink.href = module.pdfData;
        downloadLink.download = module.title ? module.title.replace(/\s+/g, '_') + '.pdf' : 'module.pdf';
      }
    }

    // Attach event listeners for view module buttons
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('viewModuleBtn')) {
        viewModule(e.target.getAttribute('data-id'));
      }
    });

    // Initial render
    renderModulesList();

    // Render final assessments filtered by student's grade
    function renderFinalAssessments() {
      const finalAssessmentsContainer = document.getElementById('finalAssessmentsContainer');
      const finalAssessmentFiles = JSON.parse(localStorage.getItem('finalAssessmentFiles') || '[]');
      const filteredFiles = finalAssessmentFiles.filter(f => f.grade === String(studentGrade));

      finalAssessmentsContainer.innerHTML = '';
      if (filteredFiles.length === 0) {
        finalAssessmentsContainer.textContent = 'No final assessments available for your grade.';
        return;
      }

        filteredFiles.forEach(file => {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'file-item';
          fileDiv.style.border = '1px solid #ccc';
          fileDiv.style.padding = '0.5rem';
          fileDiv.style.marginBottom = '1rem';

          const title = document.createElement('h3');
          title.textContent = `${file.name} (Quarter ${file.quarter})`;
          fileDiv.appendChild(title);

          if (file.url.endsWith('.pdf')) {
            const embed = document.createElement('embed');
            embed.src = file.url;
            embed.type = 'application/pdf';
            embed.style.width = '100%';
            embed.style.height = '400px';
            fileDiv.appendChild(embed);
          } else if (file.url.endsWith('.docx')) {
            const iframe = document.createElement('iframe');
            iframe.src = `https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + file.url)}&embedded=true`;
            iframe.width = '100%';
            iframe.height = '400px';
            iframe.frameBorder = '0';
            fileDiv.appendChild(iframe);
          } else {
            const link = document.createElement('a');
            link.href = file.url;
            const viewModuleBtn = document.createElement('button');
            viewModuleBtn.textContent = 'View Module';
            viewModuleBtn.style.cursor = 'pointer';
            viewModuleBtn.style.padding = '0.5rem 1rem';
            viewModuleBtn.style.fontWeight = 'bold';

            // Initially disable the "Let's play" button
            const playButton = document.createElement('button');
            playButton.textContent = "Let's play";
            playButton.style.cursor = 'pointer';
            playButton.style.padding = '0.5rem 1rem';
            playButton.style.fontWeight = 'bold';
            playButton.style.marginLeft = '0.5rem';
            playButton.disabled = true;
            playButton.style.backgroundColor = '#ccc'; // grey color when disabled
            playButton.style.color = '#666'; // darker grey text when disabled
            playButton.style.transition = 'none'; // disable transition when disabled
            playButton.addEventListener('mouseover', () => {
              if (playButton.disabled) {
                playButton.style.backgroundColor = '#ccc';
                playButton.style.color = '#666';
                playButton.style.cursor = 'not-allowed';
              }
            });
            playButton.addEventListener('mouseout', () => {
              if (playButton.disabled) {
                playButton.style.backgroundColor = '#ccc';
                playButton.style.color = '#666';
                playButton.style.cursor = 'not-allowed';
              }
            });

            // Enable "Let's play" button only after "View Module" is clicked
viewModuleBtn.addEventListener('click', () => {
  // Create a temporary link to download the file
  const link = document.createElement('a');
  link.href = file.url;
  link.download = file.name ? file.name.replace(/\s+/g, '_') + (file.url.endsWith('.pdf') ? '.pdf' : '') : 'final_assessment.pdf';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  playButton.disabled = false;
  playButton.style.backgroundColor = ''; // reset to default background color
  playButton.style.color = ''; // reset to default text color
  playButton.style.transition = ''; // enable transition when enabled
  playButton.style.cursor = 'pointer';
  playButton.removeEventListener('mouseover', () => {});
  playButton.removeEventListener('mouseout', () => {});

  // Persist the enabled state in localStorage
  const viewedModulesKey = `viewedModules_${currentUser.username}`;
  let viewedModules = JSON.parse(localStorage.getItem(viewedModulesKey)) || {};
  viewedModules[file.name] = true;
  localStorage.setItem(viewedModulesKey, JSON.stringify(viewedModules));
});

            // On page load, check if this module was viewed before and enable the play button
            const viewedModulesKey = `viewedModules_${currentUser.username}`;
            let viewedModules = JSON.parse(localStorage.getItem(viewedModulesKey)) || {};
            if (viewedModules[file.name]) {
              playButton.disabled = false;
              playButton.style.backgroundColor = ''; // reset to default background color
              playButton.style.color = ''; // reset to default text color
              playButton.style.transition = ''; // enable transition when enabled
              playButton.style.cursor = 'pointer';
              playButton.removeEventListener('mouseover', () => {});
              playButton.removeEventListener('mouseout', () => {});
            }

            playButton.addEventListener('click', () => {
              if (playButton.disabled) {
                alert('Read first the module before playing the game');
              } else {
                window.location.href = '../Owl-s-Dream-main/index.html';
              }
            });

            fileDiv.appendChild(viewModuleBtn);
            fileDiv.appendChild(playButton);
          }

        finalAssessmentsContainer.appendChild(fileDiv);
      });
    }

    renderFinalAssessments();
  </script>
</body>
</html>
