<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="../css/global.css" />
</head>
<body>
  <div class="container">
    <h1>Student Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Available Modules</h2>
      <div id="modulesList"></div>
      <div id="progressSummary" style="margin-top: 1rem;"></div>
    </section>

    <section>
      <h2>Current Module</h2>
      <div id="currentModuleContainer" style="display:none;">
        <h3 id="currentModuleTitle"></h3>
        <p id="currentModuleDescription"></p>
        <div id="questionContainer"></div>
        <button id="nextQuestionBtn">Next Question</button>
        <div id="hintContainer" style="color: #d9534f; margin-top: 1rem;"></div>
      </div>
  </section>

  <section>
    <h2>Final Assessments</h2>
    <div id="finalAssessmentsContainer"></div>
  </section>
  </div>

  <script>
    // Check if user is student
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'student') {
      alert('Access denied. Please login as Student.');
      window.location.href = '../index.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = '../index.html';
    });

    const modulesList = document.getElementById('modulesList');
    const currentModuleContainer = document.getElementById('currentModuleContainer');
    const currentModuleTitle = document.getElementById('currentModuleTitle');
    const currentModuleDescription = document.getElementById('currentModuleDescription');
    const questionContainer = document.getElementById('questionContainer');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const hintContainer = document.getElementById('hintContainer');

    let modules = JSON.parse(localStorage.getItem('modules')) || [];
    let progress = JSON.parse(localStorage.getItem('progress')) || {};
    let currentModuleId = null;
    let currentQuestionIndex = 0;
    let currentUserProgress = progress[currentUser.username] || {};

    // Filter modules by student's grade level
    const students = JSON.parse(localStorage.getItem('students')) || [];
    const studentInfo = students.find(s => s.username === currentUser.username);
    const studentGrade = studentInfo ? studentInfo.grade : null;

    function filterModulesByGrade() {
      // Filter modules to only those matching the student's grade
      if (!studentGrade) {
        return [];
      }
      return modules.filter(m => m.grade === studentGrade);
    }

    function renderModulesList() {
      const filteredModules = filterModulesByGrade();
      modulesList.innerHTML = '';
      if (filteredModules.length === 0) {
        modulesList.textContent = 'No modules available.';
        return;
      }
      filteredModules.forEach(module => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '0.5rem';
        div.style.marginBottom = '0.5rem';

        // Calculate progress for this module for current user
        const userModuleProgress = currentUserProgress[module.id];
        let progressPercent = 0;
        if (userModuleProgress) {
          const totalQuestions = module.questions ? module.questions.length : 0;
          if (totalQuestions > 0) {
            if (userModuleProgress.completed) {
              progressPercent = 100;
            } else {
              progressPercent = Math.floor((userModuleProgress.currentQuestionIndex / totalQuestions) * 100);
            }
          }
        }

        div.innerHTML = `
          <h3>${module.title}</h3>
          <p>${module.description}</p>
          <p>Progress: ${progressPercent}%</p>
          <button data-id="${module.id}" class="viewModuleBtn">View Module</button>
        `;
        modulesList.appendChild(div);
      });

      document.querySelectorAll('.startModuleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const moduleId = e.target.getAttribute('data-id');
          startModule(moduleId);
        });
      });
    }

    function startModule(moduleId) {
      currentModuleId = moduleId;
      currentQuestionIndex = currentUserProgress[moduleId]?.currentQuestionIndex || 0;
      currentModuleContainer.style.display = 'block';
      renderCurrentModule();
      renderCurrentQuestion();
    }

    // New function to view module PDF and quiz side by side
    function viewModule(moduleId) {
      const module = modules.find(m => m.id == moduleId);
      if (!module) return;

      // Show current module container
      currentModuleContainer.style.display = 'flex';
      currentModuleContainer.style.flexDirection = 'row';
      currentModuleContainer.style.gap = '2rem';

      // Clear previous content
      currentModuleTitle.textContent = module.title;
      currentModuleDescription.textContent = '';

      // Create PDF viewer iframe or embed
      let pdfViewer = document.getElementById('pdfViewer');
      if (!pdfViewer) {
        pdfViewer = document.createElement('embed');
        pdfViewer.id = 'pdfViewer';
        pdfViewer.type = 'application/pdf';
        pdfViewer.style.width = '50%';
        pdfViewer.style.height = '600px';
        currentModuleDescription.parentNode.insertBefore(pdfViewer, currentModuleDescription.nextSibling);
      }
      pdfViewer.src = module.pdfData;

      // Render quiz questions next to PDF viewer
      questionContainer.innerHTML = '';
      module.questions.forEach((q, index) => {
        const qDiv = document.createElement('div');
        qDiv.style.border = '1px solid #ccc';
        qDiv.style.padding = '0.5rem';
        qDiv.style.marginBottom = '0.5rem';
        qDiv.innerHTML = `<strong>Question ${index + 1}:</strong> ${q.text}`;
        questionContainer.appendChild(qDiv);
      });

      nextQuestionBtn.style.display = 'none';
      hintContainer.textContent = '';
    }

    function renderCurrentModule() {
      const module = modules.find(m => m.id == currentModuleId);
      if (!module) return;
      currentModuleTitle.textContent = module.title;
      currentModuleDescription.textContent = module.description;
    }

    function renderCurrentQuestion() {
      const module = modules.find(m => m.id == currentModuleId);
      if (!module) return;
      const questions = module.questions || [];
      if (currentQuestionIndex >= questions.length) {
        questionContainer.innerHTML = '<p>Module completed! Congratulations!</p>';
        nextQuestionBtn.style.display = 'none';
        hintContainer.textContent = '';
        saveProgress(true);
        return;
      }
      const question = questions[currentQuestionIndex];
      questionContainer.innerHTML = `
        <p><strong>Question ${currentQuestionIndex + 1}:</strong> ${question.text}</p>
        <input type="text" id="answerInput" placeholder="Your answer" />
      `;
      nextQuestionBtn.style.display = 'inline-block';
      hintContainer.textContent = '';
    }

    function saveProgress(completed = false) {
      if (!progress[currentUser.username]) {
        progress[currentUser.username] = {};
      }
      progress[currentUser.username][currentModuleId] = {
        currentQuestionIndex,
        completed
      };
      localStorage.setItem('progress', JSON.stringify(progress));
    }

    nextQuestionBtn.addEventListener('click', () => {
      const answerInput = document.getElementById('answerInput');
      if (!answerInput) return;
      const userAnswer = answerInput.value.trim();
      if (!userAnswer) {
        hintContainer.textContent = 'Please enter an answer before proceeding.';
        return;
      }
      const module = modules.find(m => m.id == currentModuleId);
      if (!module) return;
      const question = module.questions[currentQuestionIndex];
      if (!question) return;

      // Simple AI hint system: if answer is incorrect, show hint and do not advance
      if (userAnswer.toLowerCase() !== question.answer.toLowerCase()) {
        hintContainer.textContent = 'Hint: ' + (question.hint || 'Try reviewing the material again.');
        return;
      }

      // Correct answer: advance to next question
      currentQuestionIndex++;
      saveProgress();
      renderCurrentQuestion();
    });

    // Attach event listeners for view module buttons
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('viewModuleBtn')) {
        const moduleId = e.target.getAttribute('data-id');
        viewModule(moduleId);
      }
    });

    // Initial render
    renderModulesList();

    // Render final assessments filtered by student's grade
    function renderFinalAssessments() {
      const finalAssessmentsContainer = document.getElementById('finalAssessmentsContainer');
      const finalAssessmentFiles = JSON.parse(localStorage.getItem('finalAssessmentFiles') || '[]');
      const filteredFiles = finalAssessmentFiles.filter(f => f.grade === String(studentGrade));

      finalAssessmentsContainer.innerHTML = '';
      if (filteredFiles.length === 0) {
        finalAssessmentsContainer.textContent = 'No final assessments available for your grade.';
        return;
      }

      filteredFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';
        fileDiv.style.border = '1px solid #ccc';
        fileDiv.style.padding = '0.5rem';
        fileDiv.style.marginBottom = '1rem';

        const title = document.createElement('h3');
        title.textContent = `${file.name} (Quarter ${file.quarter})`;
        fileDiv.appendChild(title);

        if (file.url.endsWith('.pdf')) {
          const embed = document.createElement('embed');
          embed.src = file.url;
          embed.type = 'application/pdf';
          embed.style.width = '100%';
          embed.style.height = '400px';
          fileDiv.appendChild(embed);
        } else if (file.url.endsWith('.docx')) {
          const iframe = document.createElement('iframe');
          iframe.src = `https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + file.url)}&embedded=true`;
          iframe.width = '100%';
          iframe.height = '400px';
          iframe.frameBorder = '0';
          fileDiv.appendChild(iframe);
        } else {
          const link = document.createElement('a');
          link.href = file.url;
          link.textContent = 'Download file';
          fileDiv.appendChild(link);
        }

        finalAssessmentsContainer.appendChild(fileDiv);
      });
    }

    renderFinalAssessments();
  </script>
</body>
</html>
