<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="../css/global.css" />
</head>
<body>
  <div class="container">
    <h1>Student Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Available Modules</h2>
      <div id="modulesList"></div>
      <div id="progressSummary" style="margin-top: 1rem;"></div>
    </section>

    <div id="questionContainer"></div>

  <section>
    <h2>Final Assessments</h2>
    <div id="finalAssessmentsContainer"></div>
  </section>
  </div>

  <script>
    // Check if user is student
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'student') {
      alert('Access denied. Please login as Student.');
      window.location.href = '../index.html';
    }

    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = '../index.html';
    });

    const modulesList = document.getElementById('modulesList');

    let modules = [];
    let progress = {};

    let studentGrade = null;

    async function fetchModules() {
      try {
        const response = await fetch('http://localhost:5000/api/modules');
        if (!response.ok) throw new Error('Failed to fetch modules');
        const data = await response.json();
        modules = data;
        renderModulesList();
      } catch (error) {
        modulesList.textContent = 'Error loading modules.';
      }
    }

    async function fetchStudentInfo() {
      try {
        const response = await fetch('http://localhost:5000/api/students');
        if (!response.ok) throw new Error('Failed to fetch students');
        const students = await response.json();
        const studentInfo = students.find(s => s.username === currentUser.username);
        studentGrade = studentInfo ? studentInfo.grade : null;
        renderModulesList();
      } catch (error) {
        modulesList.textContent = 'Error loading student info.';
      }
    }

    function filterModulesByGrade() {
      if (!studentGrade) {
        return [];
      }
      return modules.filter(m => m.grade === studentGrade);
    }

    function renderModulesList() {
      const filteredModules = filterModulesByGrade();
      modulesList.innerHTML = '';
      if (filteredModules.length === 0) {
        modulesList.textContent = 'No modules available.';
        return;
      }
      filteredModules.forEach(module => {
        const div = document.createElement('div');
        div.style.border = '1px solid #ccc';
        div.style.padding = '0.5rem';
        div.style.marginBottom = '0.5rem';

        // Progress calculation can be updated later with API data
        let progressPercent = 0;

        div.innerHTML = `
          <h3>${module.title}</h3>
          <p>${module.description}</p>
          <p>Progress: ${progressPercent}%</p>
          <button data-id="${module.id}" class="viewModuleBtn">View Module</button>
        `;
        modulesList.appendChild(div);
      });

      document.querySelectorAll('.viewModuleBtn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const moduleId = e.target.getAttribute('data-id');
          const module = modules.find(m => m.id == moduleId);
          if (!module) return;

          // Create a temporary link to download the file
          const link = document.createElement('a');
          link.href = module.file_url || '';
          link.download = module.title ? module.title.replace(/\s+/g, '_') + '.pdf' : 'module.pdf';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      });
    }

    fetchStudentInfo();
    fetchModules();

    // New function to view module PDF and quiz side by side
    function viewModule(moduleId) {
      const module = modules.find(m => m.id == moduleId);
      if (!module) return;

      // Clear previous content
      const currentModuleTitle = document.getElementById('currentModuleTitle');
      if (currentModuleTitle) currentModuleTitle.textContent = module.title;

      const currentModuleDescription = document.getElementById('currentModuleDescription');
      if (currentModuleDescription) currentModuleDescription.textContent = '';

      const questionContainer = document.getElementById('questionContainer');
      if (questionContainer) {
        questionContainer.innerHTML = '';
        // Removed quiz questions rendering as per user request
      }

      // Display uploaded module file if available
      if (module.pdfData) {
        let pdfViewer = document.getElementById('pdfViewer');
        if (!pdfViewer) {
          pdfViewer = document.createElement('embed');
          pdfViewer.id = 'pdfViewer';
          pdfViewer.type = 'application/pdf';
          pdfViewer.style.width = '100%';
          pdfViewer.style.height = '600px';
          questionContainer.parentNode.insertBefore(pdfViewer, questionContainer.nextSibling);
        }
        pdfViewer.src = module.pdfData;

        // Add download link for the uploaded file
        let downloadLink = document.getElementById('downloadModuleFile');
        if (!downloadLink) {
          downloadLink = document.createElement('a');
          downloadLink.id = 'downloadModuleFile';
          downloadLink.textContent = 'Download Module File';
          downloadLink.style.display = 'block';
          downloadLink.style.marginTop = '1rem';
          downloadLink.style.fontWeight = 'bold';
          questionContainer.parentNode.insertBefore(downloadLink, pdfViewer.nextSibling);
        }
        downloadLink.href = module.pdfData;
        downloadLink.download = module.title ? module.title.replace(/\s+/g, '_') + '.pdf' : 'module.pdf';
      }
    }

    // Attach event listeners for view module buttons
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('viewModuleBtn')) {
        const moduleId = e.target.getAttribute('data-id');
        viewModule(moduleId);
      }
    });

    // Initial render
    renderModulesList();

    // Render final assessments filtered by student's grade
    function renderFinalAssessments() {
      const finalAssessmentsContainer = document.getElementById('finalAssessmentsContainer');
      const finalAssessmentFiles = JSON.parse(localStorage.getItem('finalAssessmentFiles') || '[]');
      const filteredFiles = finalAssessmentFiles.filter(f => f.grade === String(studentGrade));

      finalAssessmentsContainer.innerHTML = '';
      if (filteredFiles.length === 0) {
        finalAssessmentsContainer.textContent = 'No final assessments available for your grade.';
        return;
      }

      filteredFiles.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';
        fileDiv.style.border = '1px solid #ccc';
        fileDiv.style.padding = '0.5rem';
        fileDiv.style.marginBottom = '1rem';

        const title = document.createElement('h3');
        title.textContent = `${file.name} (Quarter ${file.quarter})`;
        fileDiv.appendChild(title);

        if (file.url.endsWith('.pdf')) {
          const embed = document.createElement('embed');
          embed.src = file.url;
          embed.type = 'application/pdf';
          embed.style.width = '100%';
          embed.style.height = '400px';
          fileDiv.appendChild(embed);
        } else if (file.url.endsWith('.docx')) {
          const iframe = document.createElement('iframe');
          iframe.src = `https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + file.url)}&embedded=true`;
          iframe.width = '100%';
          iframe.height = '400px';
          iframe.frameBorder = '0';
          fileDiv.appendChild(iframe);
        } else {
          const link = document.createElement('a');
          link.href = file.url;
          const viewModuleBtn = document.createElement('button');
          viewModuleBtn.textContent = 'View Module';
          viewModuleBtn.style.cursor = 'pointer';
          viewModuleBtn.style.padding = '0.5rem 1rem';
          viewModuleBtn.style.fontWeight = 'bold';
          viewModuleBtn.addEventListener('click', () => {
            window.open(file.url, '_blank');
          });
          fileDiv.appendChild(viewModuleBtn);

          // Add "Let's play" button next to "View Module"
          const playButton = document.createElement('button');
          playButton.textContent = "Let's play";
          playButton.style.cursor = 'pointer';
          playButton.style.padding = '0.5rem 1rem';
          playButton.style.fontWeight = 'bold';
          playButton.style.marginLeft = '0.5rem';
          playButton.addEventListener('click', () => {
            window.location.href = 'https://blast-zone-out.github.io/Math-Venture/';
          });
          fileDiv.appendChild(playButton);
        }

        finalAssessmentsContainer.appendChild(fileDiv);
      });
    }

    renderFinalAssessments();
  </script>
</body>
</html>
