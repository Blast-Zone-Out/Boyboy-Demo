<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Dashboard</title>
  <link rel="stylesheet" href="../css/admin-dashboard-modern.css" />
  <style>
    .header-center nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: white;
      font-weight: 500;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .header-center nav a:hover {
      color: #93c5fd; /* lighter blue on hover */
    }
    .header-center nav a:focus {
      outline: none; /* remove focus outline */
      box-shadow: none; /* remove focus box shadow */
    }
  
    .tab-content {
      display: block; /* Show all tab contents since no tab switching */
      padding: 1rem 0;
    }
    /* Scoped styles replicating login page design for add student section */
    #add-student .container {
      background: #ffffffdd;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(44, 62, 80, 0.2);
      padding: 2rem 2rem;
      max-width: 450px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      display: grid;
      grid-template-columns: 1fr;
      grid-gap: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    #add-student h1 {
      font-weight: 700;
      color: #34495e;
      letter-spacing: 0.05em;
      margin: 0 0 1rem 0;
      font-size: 2.5rem;
      text-align: center;
    }
    #add-student form {
      display: grid;
      grid-gap: 1rem;
      position: relative;
      z-index: 1;
    }
    #add-student label {
      font-weight: 600;
      font-size: 1rem;
      color: #34495e;
      letter-spacing: 0.05em;
    }
    #add-student input[type="text"],
    #add-student input[type="password"],
    #add-student select {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #2980b9;
      border-radius: 8px;
      background: #f9fbff;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Roboto Mono', monospace;
    }
    #add-student input[type="text"]:focus,
    #add-student input[type="password"]:focus,
    #add-student select:focus {
      border-color: #1abc9c;
      box-shadow: 0 0 8px #1abc9c;
      outline: none;
    }
    #add-student button {
      padding: 0.85rem 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #2980b9, #1abc9c);
      border: none;
      border-radius: 12px;
      cursor: default; /* disable pointer cursor */
      font-family: 'Roboto Mono', monospace;
      box-shadow: 0 4px 12px rgba(26, 188, 156, 0.4);
    }
    #add-student button:hover {
      background: linear-gradient(135deg, #2980b9, #1abc9c); /* no hover effect */
      transform: none;
    }
    #add-student button:active {
      transform: none;
    }
    /* Add Module section styles */
    #add-module .container {
      background: #ffffffdd;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(44, 62, 80, 0.2);
      padding: 2rem 2rem;
      max-width: 450px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      display: grid;
      grid-template-columns: 1fr;
      grid-gap: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    #add-module h1 {
      font-weight: 700;
      color: #34495e;
      letter-spacing: 0.05em;
      margin: 0 0 1rem 0;
      font-size: 2.5rem;
      text-align: center;
    }
    #add-module form {
      display: grid;
      grid-gap: 1rem;
      position: relative;
      z-index: 1;
    }
    #add-module label {
      font-weight: 600;
      font-size: 1rem;
      color: #34495e;
      letter-spacing: 0.05em;
    }
    #add-module input[type="text"],
    #add-module textarea,
    #add-module select {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #2980b9;
      border-radius: 8px;
      background: #f9fbff;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Roboto Mono', monospace;
    }
    #add-module input[type="text"]:focus,
    #add-module textarea:focus,
    #add-module select:focus {
      border-color: #1abc9c;
      box-shadow: 0 0 8px #1abc9c;
      outline: none;
    }
    #add-module button {
      padding: 0.85rem 1rem;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #2980b9, #1abc9c);
      border: none;
      border-radius: 12px;
      cursor: default; /* disable pointer cursor */
      font-family: 'Roboto Mono', monospace;
      box-shadow: 0 4px 12px rgba(26, 188, 156, 0.4);
    }
    #add-module button:hover {
      background: linear-gradient(135deg, #2980b9, #1abc9c); /* no hover effect */
      transform: none;
    }
    #add-module button:active {
      transform: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo-icon" aria-label="Book icon" title="Book icon">ü¶â</div>
      <div class="brand-name">MathVenture</div>
    </div>
  <div class="header-center">
<nav>
  <a href="new-dashboard.html" class="tab-link active" data-tab="dashboard">Dashboard</a>
  <a href="#" class="tab-link" data-tab="game">Game</a>
  <a href="final-assessment.html" class="tab-link" data-tab="final-assessment">Final Assessment</a>
</nav>
  </div>
    <div class="header-right">
      <div id="userAvatar" class="user-avatar" aria-label="User avatar" title="User avatar">TE</div>
      <div id="username" class="username">Teacher</div>
      <div id="gradeBadge" class="grade-badge" style="display:none;"></div>
      <div id="logoutBtn" class="logout" role="button" tabindex="0" aria-label="Logout">Logout</div>
    </div>
  </header>
  <main>
    <section id="dashboard" class="tab-content active" aria-label="Dashboard">
      <h1>Student Dashboard</h1>
      <div class="summary-cards">
        <div class="card purple">
          <div class="icon" aria-label="Total Modules icon" title="Total Modules">üìö</div>
          <div class="text">
            <div class="label">Total Modules</div>
            <div class="value" id="totalModules">0</div>
          </div>
        </div>
        <div class="card green">
          <div class="icon" aria-label="Active Classes icon" title="Active Classes">üè´</div>
          <div class="text">
            <div class="label">Unfinished Final Assesment </div>
            <div class="value" id="activeClasses">0</div>
          </div>
        </div>
        <div class="card orange">
          <div class="icon" aria-label="Average Score icon" title="Average Score">üìä</div>
          <div class="text">
            <div class="label">Average Score</div>
            <div class="value" id="averageScore">0%</div>
          </div>
        </div>
      </div>
    </section>

    <section id="game" class="tab-content" aria-label="Game" style="display:none;">
      <h1>Assesment - Let's play some game</h1>
      <div class="quick-actions">
        <div class="quick-action-btn" role="button" tabindex="0" aria-label="Start New Game" id="startNewGameBtn">
          <div class="icon">üéÆ</div>
          <div>Play Game</div>
        </div>
        <div class="quick-action-btn" role="button" tabindex="0" aria-label="View Game Scores">
          <div class="icon">üìä</div>
          <div>View Game Scores</div>
        </div>
      </div>
    </section>
    <section id="final-assessment" class="tab-content" aria-label="Final Assessment" style="display:none;">
      <h1>Final Assessment</h1>
      <div class="quick-actions">
        <div class="quick-action-btn" role="button" tabindex="0" aria-label="View Module">
          <div class="icon">üìö</div>
          <div>View Module</div>
        </div>
        <!-- Removed global Take Final Assessment button as it will be per module -->
        <!--
        <div class="quick-action-btn" role="button" tabindex="0" aria-label="Take Final Assessment" id="takeFinalAssessmentBtn">
          <div class="icon">‚úçÔ∏è</div>
          <div>Take Final Assessment</div>
        </div>
        -->
        <div class="quick-action-btn" role="button" tabindex="0" aria-label="View Assessment Results" id="viewAssessmentResultsBtn">
          <div class="icon">üìà</div>
          <div>View Assessment Results</div>
        </div>
      </div>
      <div id="finalAssessmentQuestionsContainer" style="margin-top: 1rem; display: none; max-height: 500px; overflow-y: auto; border: 1px solid #2980b9; border-radius: 8px; padding: 1rem; background: #f9fbff;">
        <h3>Final Assessment Questions</h3>
        <form id="finalAssessmentForm">
          <div id="questionsList"></div>
          <button type="submit" style="margin-top: 1rem; padding: 0.5rem 1rem; font-weight: 700; background: #1abc9c; color: white; border: none; border-radius: 6px; cursor: pointer;">Submit Answers</button>
        </form>
        <div id="finalAssessmentMessage" style="margin-top: 1rem; font-weight: 600;"></div>
      </div>
      <div id="assessmentResultsContainer" style="margin-top: 1rem; display: none; max-height: 300px; overflow-y: auto; border: 1px solid #2980b9; border-radius: 8px; padding: 1rem; background: #f9fbff;">
        <h3>Assessment Results</h3>
        <div id="assessmentScore"></div>
      </div>
    </section>
   
      </main>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));

      if (currentUser && currentUser.role === "student") {
        const usernameDiv = document.getElementById("username");
        if (usernameDiv) {
          usernameDiv.textContent = currentUser.name || currentUser.username || "Student";
        }
        const userAvatarDiv = document.getElementById("userAvatar");
        if (userAvatarDiv) {
          const initial = (currentUser.name || currentUser.username || "S").charAt(0).toUpperCase();
          userAvatarDiv.textContent = initial;
        }

        // Update total modules count for the teacher per grade account
      // Function to update unfinished final assessments count and average score
      function updateDashboardStats() {
        const totalModulesElem = document.getElementById('totalModules');
        const unfinishedCountElem = document.getElementById('activeClasses');
        const averageScoreElem = document.getElementById('averageScore');
        const modules = JSON.parse(localStorage.getItem('modules') || '[]');
        const userGrade = currentUser.grade ? currentUser.grade.toString() : null;
        const filteredModules = userGrade ? modules.filter(m => m.grade === userGrade) : modules;

        if (totalModulesElem) {
          totalModulesElem.textContent = filteredModules.length.toString();
        }

        if (unfinishedCountElem) {
          let unfinishedCount = 0;
          filteredModules.forEach(module => {
            const completedKey = `finalAssessmentCompleted_${currentUser.username}_${module.title}`;
            const isCompleted = localStorage.getItem(completedKey) === 'true';
            if (!isCompleted) {
              unfinishedCount++;
            }
          });
          unfinishedCountElem.textContent = unfinishedCount.toString();
        }

        if (averageScoreElem) {
          let totalCorrect = 0;
          let totalQuestions = 0;
          filteredModules.forEach(module => {
            const completedKey = `finalAssessmentCompleted_${currentUser.username}_${module.title}`;
            const isCompleted = localStorage.getItem(completedKey) === 'true';
            if (isCompleted) {
              const userAnswersKey = `finalAssessmentAnswers_${currentUser.username}_${module.title}`;
              const userAnswers = JSON.parse(localStorage.getItem(userAnswersKey) || '{}');
              if (userAnswers && Object.keys(userAnswers).length > 0) {
                let correctCount = 0;
                module.questions.forEach((q, index) => {
                  const userAnswer = userAnswers[`${module.title}_answer${index + 1}`] || userAnswers[`answer${index + 1}`];
                  if (userAnswer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase()) {
                    correctCount++;
                  }
                });
                totalCorrect += correctCount;
                totalQuestions += module.questions.length;
              }
            }
          });
          const avgScorePercent = totalQuestions > 0 ? ((totalCorrect / totalQuestions) * 100).toFixed(2) : '0.00';
          averageScoreElem.textContent = `${avgScorePercent}%`;
        }
      }

      // Initial call to update counts and average score on page load
      updateDashboardStats();

        // Auto show assessment results if completed
        const assessmentResultsContainer = document.getElementById('assessmentResultsContainer');
        const assessmentScoreDiv = document.getElementById('assessmentScore');
        const finalAssessmentQuestionsContainer = document.getElementById('finalAssessmentQuestionsContainer');

        const completedAny = localStorage.getItem(`finalAssessmentCompleted_${currentUser.username}`) === 'true';
        if (completedAny) {
          // Load modules from localStorage
          const modules = JSON.parse(localStorage.getItem('modules') || '[]');
          const userGrade = currentUser.grade ? currentUser.grade.toString() : null;
          const filteredModules = userGrade ? modules.filter(m => m.grade === userGrade) : modules;

          if (filteredModules.length > 0) {
            // Retrieve user's answers from localStorage
            const userAnswersKey = `finalAssessmentAnswers_${currentUser.username}`;
            const userAnswers = JSON.parse(localStorage.getItem(userAnswersKey) || '{}');

            if (userAnswers && Object.keys(userAnswers).length > 0) {
              // Clear previous results
              assessmentScoreDiv.innerHTML = '';

              // Iterate over each module and calculate score separately
              filteredModules.forEach(module => {
                let correctCount = 0;
                module.questions.forEach((q, index) => {
                  const userAnswer = userAnswers[`${module.title}_answer${index + 1}`] || userAnswers[`answer${index + 1}`];
                  if (userAnswer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase()) {
                    correctCount++;
                  }
                });

                const totalQuestions = module.questions.length;
                const scorePercent = ((correctCount / totalQuestions) * 100).toFixed(2);

                // Retrieve time taken from localStorage
                let timeTakenMinutes = null;
                if (currentUser && currentUser.username) {
                  const timeTakenStr = localStorage.getItem(`finalAssessmentTimeTaken_${currentUser.username}_${module.title}`);
                  if (timeTakenStr) {
                    timeTakenMinutes = timeTakenStr;
                  }
                }

                // Append each module's result
                const passed = correctCount >= 8;
                const passFailText = passed ? '<span style="color: green; font-weight: 700;">Passed</span>' : '<span style="color: red; font-weight: 700;">Failed</span>';
                const timeTakenText = timeTakenMinutes !== null ? `<p>Time Taken: ${timeTakenMinutes} minute(s)</p>` : '';
                const moduleResultHTML = `
                  <div style="border: 1px solid #2980b9; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: #e0f7fa;">
                    <h4>Module: ${module.title}</h4>
                    <p>You scored ${correctCount} out of ${totalQuestions} questions correctly.</p>
                    <p>Percentage: ${scorePercent}%</p>
                    <p>Status: ${passFailText}</p>
                    ${timeTakenText}
                  </div>
                `;
                assessmentScoreDiv.innerHTML += moduleResultHTML;
              });

              // Show the results container and hide the questions container
              assessmentResultsContainer.style.display = 'block';
              finalAssessmentQuestionsContainer.style.display = 'none';
            }
          }
        }
      }
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          localStorage.removeItem("currentUser");
          window.location.href = "../index.html";
        });
      }

     

      // On page load, do not disable Take Final Assessment button
      if (currentUser && currentUser.username) {
        const completed = localStorage.getItem(`finalAssessmentCompleted_${currentUser.username}`) === 'true';
        if (completed) {
          // Do not disable the Take Final Assessment button
        }
      }

      // View Assessment Results button functionality
      const viewAssessmentResultsBtn = document.getElementById('viewAssessmentResultsBtn');
      const assessmentResultsContainer = document.getElementById('assessmentResultsContainer');
      const assessmentScoreDiv = document.getElementById('assessmentScore');

      viewAssessmentResultsBtn.addEventListener('click', () => {
        if (!currentUser || !currentUser.username) {
          alert('User not logged in.');
          return;
        }

        // Toggle visibility of assessment results container
        if (assessmentResultsContainer.style.display === 'block') {
          assessmentResultsContainer.style.display = 'none';
          return;
        }

        // Load modules from localStorage
        const modules = JSON.parse(localStorage.getItem('modules') || '[]');
        const userGrade = currentUser.grade ? currentUser.grade.toString() : null;
        const filteredModules = userGrade ? modules.filter(m => m.grade === userGrade) : modules;

        if (filteredModules.length === 0) {
          alert('No final assessment modules available for your grade.');
          return;
        }

        // Clear previous results
        assessmentScoreDiv.innerHTML = '';

        // Iterate over each module and calculate score separately
        filteredModules.forEach(module => {
          // Retrieve user's answers for this module from localStorage
          const userAnswersKey = `finalAssessmentAnswers_${currentUser.username}_${module.title}`;
          const userAnswers = JSON.parse(localStorage.getItem(userAnswersKey) || '{}');

          if (!userAnswers || Object.keys(userAnswers).length === 0) {
            // Skip this module if no answers found
            return;
          }

          let correctCount = 0;
          module.questions.forEach((q, index) => {
            const userAnswer = userAnswers[`${module.title}_answer${index + 1}`] || userAnswers[`answer${index + 1}`];
            if (userAnswer && userAnswer.trim().toLowerCase() === q.answer.trim().toLowerCase()) {
              correctCount++;
            }
          });

          const totalQuestions = module.questions.length;
          const scorePercent = ((correctCount / totalQuestions) * 100).toFixed(2);

          // Retrieve time taken from localStorage
          let timeTakenMinutes = null;
          if (currentUser && currentUser.username) {
            const timeTakenStr = localStorage.getItem(`finalAssessmentTimeTaken_${currentUser.username}_${module.title}`);
            if (timeTakenStr) {
              timeTakenMinutes = timeTakenStr;
            }
          }

          // Append each module's result
          const passed = correctCount >= 8;
          const passFailText = passed ? '<span style="color: green; font-weight: 700;">Passed</span>' : '<span style="color: red; font-weight: 700;">Failed</span>';
          const timeTakenText = timeTakenMinutes !== null ? `<p>Time Taken: ${timeTakenMinutes} minute(s)</p>` : '';
          const moduleResultHTML = `
            <div style="border: 1px solid #2980b9; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background: #e0f7fa;">
              <h4>Module: ${module.title}</h4>
              <p>You scored ${correctCount} out of ${totalQuestions} questions correctly.</p>
              <p>Percentage: ${scorePercent}%</p>
              <p>Status: ${passFailText}</p>
              ${timeTakenText}
            </div>
          `;
          assessmentScoreDiv.innerHTML += moduleResultHTML;

          // Save scorePercent in localStorage for teacher dashboard use per module
          if (currentUser && currentUser.username) {
            localStorage.setItem(`finalAssessmentScore_${currentUser.username}_${module.title}`, scorePercent);
          }
        });

        // Show the results container and hide the questions container
        assessmentResultsContainer.style.display = 'block';
        finalAssessmentQuestionsContainer.style.display = 'none';
      });

      // Modify final assessment form submission to save answers
        finalAssessmentForm.addEventListener('submit', (e) => {
          e.preventDefault();

          // Confirmation dialog before submission
          const confirmSubmit = confirm("Do you want to submit your answer?");
          if (!confirmSubmit) {
            return;
          }

        finalAssessmentMessage.style.color = 'green';
        finalAssessmentMessage.textContent = 'Your answers have been submitted. Thank you!';

        // Save answers to localStorage
        const formData = new FormData(finalAssessmentForm);
        const answers = {};
        for (const [key, value] of formData.entries()) {
          answers[key] = value;
        }
        if (currentUser && currentUser.username) {
          const currentModule = finalAssessmentForm.getAttribute('data-current-module');
          localStorage.setItem(`finalAssessmentAnswers_${currentUser.username}_${currentModule}`, JSON.stringify(answers));
          localStorage.setItem(`finalAssessmentCompleted_${currentUser.username}_${currentModule}`, 'true');

          // Calculate and save time taken for assessment
          const startTimeKey = `finalAssessmentStartTime_${currentUser.username}_${currentModule}`;
          const startTimeStr = localStorage.getItem(startTimeKey);
          if (startTimeStr) {
            const startTime = new Date(startTimeStr);
            const endTime = new Date();
            const timeTakenMinutes = Math.round((endTime - startTime) / 60000); // convert ms to minutes
            localStorage.setItem(`finalAssessmentTimeTaken_${currentUser.username}_${currentModule}`, timeTakenMinutes.toString());
            localStorage.removeItem(startTimeKey);
          }

          // Increment final assessment attempts count per module
          const attemptKey = `finalAssessmentAttempts_${currentUser.username}_${currentModule}`;
          let attempts = parseInt(localStorage.getItem(attemptKey) || '0', 10);
          attempts += 1;
          localStorage.setItem(attemptKey, attempts.toString());

          // Disable the Take Final Assessment button immediately
          const takeButtons = document.querySelectorAll('.takeFinalAssessmentModuleBtn');
          takeButtons.forEach(btn => {
            if (btn.getAttribute('data-module-title') === currentModule) {
              btn.disabled = true;
              btn.style.opacity = '0.6';
              btn.style.cursor = 'not-allowed';
              btn.textContent = 'Assessment Completed';
            }
          });

          // Update unfinished count after submission
          updateDashboardStats();
        }

        finalAssessmentForm.reset();
        // Hide the questions container
        finalAssessmentQuestionsContainer.style.display = 'none';
        });

      // Quick Actions content switching based on tab clicks
      const tabLinks = document.querySelectorAll(".header-center nav a.tab-link");
      const tabContents = document.querySelectorAll(".tab-content");

      tabLinks.forEach(tab => {
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          const tabName = tab.getAttribute("data-tab");

          // Remove active class from all tabs and add to clicked tab
          tabLinks.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");

          // Hide all tab contents
          tabContents.forEach(content => {
            content.style.display = "none";
            content.classList.remove("active");
          });

          // Show the selected tab content
          const activeContent = document.getElementById(tabName);
          if (activeContent) {
            activeContent.style.display = "block";
            activeContent.classList.add("active");
          }
        });
      });

      // Add event listener for Start New Game button
      const startNewGameBtn = document.getElementById("startNewGameBtn");
      if (startNewGameBtn) {
        startNewGameBtn.addEventListener("click", () => {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) {
            alert("User not logged in.");
            return;
          }
          const key = `moduleRead_${currentUser.username || currentUser.name || 'default'}`;
          const hasReadModule = localStorage.getItem(key) === 'true';

          if (Number(currentUser.grade) === 4) {
            if (!hasReadModule) {
              // Redirect to PDF reader page to read the module
              window.location.href = "pdf-reader.html";
            } else {
              // Ask if user wants to read again
              const readAgain = confirm("Do you want to read again this module?");
              if (readAgain) {
                // Reset read status and redirect to PDF reader
                localStorage.removeItem(key);
                window.location.href = "pdf-reader.html";
              } else {
                // Proceed to game
                window.location.href = "../Owl-s-Dream-main/index.html";
              }
            }
          } else if (Number(currentUser.grade) === 5) {
            if (!hasReadModule) {
              // Redirect to grade 5 module reading page
              window.location.href = "grade5-module.html";
            } else {
              // Ask if user wants to read again
              const readAgain = confirm("Do you want to read again this module?");
              if (readAgain) {
                localStorage.removeItem(key);
                window.location.href = "grade5-module.html";
              } else {
                window.location.href = "../Owl-s-Grade-5-main/index.html";
              }
            }
          } else if (Number(currentUser.grade) === 6) {
            if (!hasReadModule) {
              // Redirect to grade 6 module reading page
              window.location.href = "grade6-module.html";
            } else {
              // Ask if user wants to read again
              const readAgain = confirm("Do you want to read again this module?");
              if (readAgain) {
                localStorage.removeItem(key);
                window.location.href = "grade6-module.html";
              } else {
                window.location.href = "../Owl-s-Grade-6-main/index.html";
              }
            }
          } else {
            alert("Game is available for Grade 4 students only.");
          }
        });
      }

      // Add event listener for View Module button
      const viewModuleBtn = document.querySelector('[aria-label="View Module"]');
      const modulesContainer = document.createElement('div');
      modulesContainer.id = 'modulesContainer';
      modulesContainer.style.marginTop = '1rem';
      modulesContainer.style.maxHeight = '400px';
      modulesContainer.style.overflowY = 'auto';
      modulesContainer.style.border = '1px solid #2980b9';
      modulesContainer.style.borderRadius = '8px';
      modulesContainer.style.padding = '1rem';
      modulesContainer.style.background = '#f9fbff';
      modulesContainer.style.display = 'none';

      const finalAssessmentSection = document.getElementById('final-assessment');
      finalAssessmentSection.appendChild(modulesContainer);

      const modulesList = document.createElement('div');
      modulesList.id = 'modulesList';
      modulesContainer.appendChild(modulesList);

      const finalAssessmentFilesList = document.createElement('div');
      finalAssessmentFilesList.id = 'finalAssessmentFilesList';
      modulesContainer.appendChild(finalAssessmentFilesList);

      viewModuleBtn.addEventListener('click', () => {
        if (modulesContainer.style.display === 'none' || modulesContainer.style.display === '') {
          modulesContainer.style.display = 'block';

          // Load modules and final assessment files from localStorage
          const modules = JSON.parse(localStorage.getItem('modules') || '[]');
          const finalAssessmentFiles = JSON.parse(localStorage.getItem('finalAssessmentFiles') || '[]');

          // Get current user grade
          const currentUser = JSON.parse(localStorage.getItem('currentUser'));
          const userGrade = currentUser && currentUser.grade ? currentUser.grade.toString() : null;

          // Filter modules and files by user grade
          const filteredModules = userGrade ? modules.filter(m => m.grade === userGrade) : modules;
          const filteredFinalAssessmentFiles = userGrade ? finalAssessmentFiles.filter(f => f.grade === userGrade) : finalAssessmentFiles;

          // Render modules
          if (filteredModules.length === 0) {
            modulesList.innerHTML = '<p>No modules uploaded yet for your grade.</p>';
          } else {
            modulesList.innerHTML = '<h3>Modules Uploaded by Teacher</h3>';
            filteredModules.forEach(module => {
              const moduleDiv = document.createElement('div');
              moduleDiv.style.border = '1px solid #ccc';
              moduleDiv.style.padding = '0.5rem';
              moduleDiv.style.marginBottom = '0.5rem';

              // Check if user has completed this module's final assessment
              const currentUser = JSON.parse(localStorage.getItem('currentUser'));
              const completedKey = `finalAssessmentCompleted_${currentUser.username}_${module.title}`;
              const isCompleted = localStorage.getItem(completedKey) === 'true';

              moduleDiv.innerHTML = `
                <strong>Title:</strong> ${module.title}<br/>
                <strong>Description:</strong> ${module.description}<br/>
                <strong>Grade:</strong> ${module.grade}<br/>
                <button class="downloadModuleBtn" data-file="${encodeURIComponent(module.fileData)}" data-filename="${module.title}.pdf">Download Module File</button>
                <button class="takeFinalAssessmentModuleBtn" data-module-title="${module.title}" ${isCompleted ? 'disabled style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                  ${isCompleted ? 'Assessment Completed' : 'Take Final Assessment'}
                </button>
              `;
              modulesList.appendChild(moduleDiv);
            });
            // Add event listeners for download buttons
            modulesList.querySelectorAll('.downloadModuleBtn').forEach(btn => {
              btn.addEventListener('click', () => {
                const fileData = decodeURIComponent(btn.getAttribute('data-file'));
                const filename = btn.getAttribute('data-filename');
                // Convert base64 to Blob
                const byteString = atob(fileData.split(',')[1]);
                const mimeString = fileData.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                  ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], { type: mimeString });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                }, 0);
              });
            });
            // Add event listeners for take final assessment buttons
            modulesList.querySelectorAll('.takeFinalAssessmentModuleBtn').forEach(btn => {
              btn.addEventListener('click', () => {
                const moduleTitle = btn.getAttribute('data-module-title');
            // Show the questions container
            finalAssessmentQuestionsContainer.style.display = 'block';
            finalAssessmentMessage.textContent = '';
            questionsList.innerHTML = '';

            // Load modules from localStorage
            const modules = JSON.parse(localStorage.getItem('modules') || '[]');

            // Find the module by title
            const module = modules.find(m => m.title === moduleTitle);

            if (!module) {
              questionsList.innerHTML = '<p>Module not found for final assessment.</p>';
              return;
            }

            // Record start time of assessment for this user and module
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.username) {
              const startTimeKey = `finalAssessmentStartTime_${currentUser.username}_${module.title}`;
              localStorage.setItem(startTimeKey, new Date().toISOString());
            }

            // Display module title
            const moduleTitleElem = document.createElement('h4');
            moduleTitleElem.textContent = `Module: ${module.title}`;
            questionsList.appendChild(moduleTitleElem);

            // Display questions with input fields for answers
            module.questions.forEach((q, index) => {
              const questionDiv = document.createElement('div');
              questionDiv.style.marginBottom = '1rem';

              const questionLabel = document.createElement('label');
              questionLabel.textContent = `Q${index + 1}: ${q.question}`;
              questionLabel.setAttribute('for', `answer${index + 1}`);

              const answerInput = document.createElement('input');
              answerInput.type = 'text';
              answerInput.id = `answer${index + 1}`;
              answerInput.name = `answer${index + 1}`;
              answerInput.style.width = '100%';
              answerInput.style.padding = '0.5rem';
              answerInput.style.marginTop = '0.25rem';
              answerInput.required = true;

              questionDiv.appendChild(questionLabel);
              questionDiv.appendChild(answerInput);
              questionsList.appendChild(questionDiv);
            });

            // Store current module title for submission
            finalAssessmentForm.setAttribute('data-current-module', module.title);

            // Show the form
            finalAssessmentForm.style.display = 'block';
              });
            });
          }

          // Render final assessment files
          if (filteredFinalAssessmentFiles.length === 0) {
            finalAssessmentFilesList.innerHTML = '';
          } else {
            finalAssessmentFilesList.innerHTML = '<h3>Final Assessment Files</h3>';
            filteredFinalAssessmentFiles.forEach(file => {
              const fileDiv = document.createElement('div');
              fileDiv.style.border = '1px solid #ccc';
              fileDiv.style.padding = '0.5rem';
              fileDiv.style.marginBottom = '0.5rem';
              fileDiv.innerHTML = `
                <strong>Name:</strong> ${file.name}<br/>
                <strong>Grade:</strong> ${file.grade}<br/>
                <strong>Quarter:</strong> ${file.quarter}<br/>
                <button class="downloadFinalAssessmentBtn" data-url="${file.url}" data-filename="${file.name}">Download File</button>
              `;
              finalAssessmentFilesList.appendChild(fileDiv);
            });
            // Add event listeners for final assessment download buttons
            finalAssessmentFilesList.querySelectorAll('.downloadFinalAssessmentBtn').forEach(btn => {
              btn.addEventListener('click', () => {
                const url = btn.getAttribute('data-url');
                const filename = btn.getAttribute('data-filename');
                // Create a temporary link to download
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                  document.body.removeChild(a);
                }, 0);
              });
            });
          }
        } else {
          modulesContainer.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
